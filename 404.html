<!DOCTYPE html>
<html lang="ar" dir="rtl">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>فتح التطبيق</title>
<style>
  body {font-family: system-ui, -apple-system, Segoe UI, Tahoma; padding: 40px; text-align: center;}
  .btn {display:inline-block; padding:12px 18px; border-radius:10px; border:none; background:#2b7a0b; color:#fff; font-size:16px; cursor:pointer;}
  .hint {color:#666; margin-top:10px; font-size:14px;}
</style>
<script>
(function () {
  // ←← عدّل هذه القيم حسب تطبيقك
  const androidPkg  = "com.legend.lulua";
  const iosAppId    = "1234567890";
  const fallbackWeb = "https://snapmall.ps/download";

  // استخراج معرف المنتج من المسار: /p/15569 → 15569
  const parts = location.pathname.replace(/\/+$/,'').split('/');
  const productId = (parts.length >= 2 && parts[parts.length-2] === 'p') ? parts[parts.length-1] : '0';

  // روابط السكيم
  const schemePath  = "snapmall://p/" + productId;     // snapmall://p/15650
  const schemeQuery = "snapmall://p?id=" + productId;  // snapmall://p?id=15650

  const playUrl   = "https://play.google.com/store/apps/details?id=" + androidPkg;
  const appStoreUrl = iosAppId ? ("https://apps.apple.com/app/id" + iosAppId) : fallbackWeb;

  // intent (أفضل دعم على كروم/واتساب بالأندرويد)
  const intentUrl = "intent://p/" + encodeURIComponent(productId) +
                    "#Intent;scheme=snapmall;package=" + androidPkg +
                    ";S.browser_fallback_url=" + encodeURIComponent(playUrl) +
                    ";end";

  const ua = navigator.userAgent || navigator.vendor || "";
  const isAndroid = /Android/i.test(ua);
  const isIOS     = /iPhone|iPad|iPod/i.test(ua);

  function openFallback() {
    if (isAndroid) {
      location.href = playUrl;
    } else if (isIOS) {
      location.href = appStoreUrl;
    } else {
      location.href = fallbackWeb;
    }
  }

  // 🔒 إغلاق/رجوع الصفحة عند انتقال المستخدم للتطبيق (الصفحة تصبح مخفية)
  let closeScheduled = false;
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && !closeScheduled) {
      closeScheduled = true;
      // ننتظر قليلًا لنضمن التحويل تم
      setTimeout(() => {
        // حاول إغلاق الصفحة
        window.close();
        // لو ما سمح المتصفح بالإغلاق:
        if (!document.hidden) return; // عاد المستخدم بسرعة، لا تغلق
        if (history.length > 1) {
          history.back();
        } else {
          // نافذة مستقلة أو دون تاريخ: أفرغ الصفحة
          location.replace('about:blank');
        }
      }, 800);
    }
  });

  // تشغيل تلقائي
  function tryAutoOpen() {
    alert(1);
    const t0 = Date.now();

    if (isAndroid) {
      // 1) جرّب السكيم (path ثم query) سريعًا
      location.href = schemePath;
      setTimeout(() => { if (Date.now()-t0 < 600) location.href = schemeQuery; }, 200);
      // 2) intent:// أقوى دعم على كروم/واتساب
      setTimeout(() => {
        if (Date.now() - t0 < 1200) location.href = intentUrl;
      }, 400);
      // 3) Fallback أخير لو ما تم التحويل
      setTimeout(() => {
        if (Date.now() - t0 < 1800) openFallback();
      }, 1600);

    } else if (isIOS) {
      // iOS: جرّب السكيم (path ثم query) ثم Fallback
      location.href = schemePath;
      setTimeout(() => { if (Date.now()-t0 < 800) location.href = schemeQuery; }, 300);
      setTimeout(openFallback, 1200);

    } else {
      openFallback();
    }
  }

  // زر يدوي (لو التلقائي حُجب بواسطة in-app browser)
  window.tryOpenManually = function () {
    if (isAndroid) {
      location.href = intentUrl;
      setTimeout(() => { location.href = schemeQuery; }, 200);
      setTimeout(() => { location.href = schemePath;  }, 400);
      setTimeout(openFallback, 1500);
    } else if (isIOS) {
      location.href = schemePath;
      setTimeout(() => { location.href = schemeQuery; }, 400);
      setTimeout(openFallback, 1200);
    } else {
      openFallback();
    }
  };

  tryAutoOpen();
  // فعّل التلقائي عند التحميل
  // window.addEventListener('load', tryAutoOpen);
})();
</script>

<body>
  <h2>جاري فتح التطبيق…</h2>
  <p class="hint">إذا لم يُفتح تلقائيًا، اضغط الزر أدناه:</p>
  <button class="btn" onclick="tryOpenManually()">افتح التطبيق الآن</button>
  <p class="hint">إن تعذّر الفتح، سيتم تحويلك للمتجر تلقائيًا.</p>
</body>
</html>
