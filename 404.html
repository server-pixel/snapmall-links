<!DOCTYPE html>
<html lang="ar" dir="rtl">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</title>
<style>
  body {font-family: system-ui, -apple-system, Segoe UI, Tahoma; padding: 40px; text-align: center;}
  .btn {display:inline-block; padding:12px 18px; border-radius:10px; border:none; background:#2b7a0b; color:#fff; font-size:16px; cursor:pointer;}
  .hint {color:#666; margin-top:10px; font-size:14px;}
</style>
<script>
(function () {
  // â†â† Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ø­Ø³Ø¨ ØªØ·Ø¨ÙŠÙ‚Ùƒ
  const androidPkg  = "com.legend.lulua";
  const iosAppId    = "1234567890";
  const fallbackWeb = "https://snapmall.ps/download";

  // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±: /p/15569 â†’ 15569
  const parts = location.pathname.replace(/\/+$/,'').split('/');
  const productId = (parts.length >= 2 && parts[parts.length-2] === 'p') ? parts[parts.length-1] : '0';

  // Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø³ÙƒÙŠÙ…
  const schemePath  = "snapmall://p/" + productId;     // snapmall://p/15650
  const schemeQuery = "snapmall://p?id=" + productId;  // snapmall://p?id=15650

  const playUrl   = "https://play.google.com/store/apps/details?id=" + androidPkg;
  const appStoreUrl = iosAppId ? ("https://apps.apple.com/app/id" + iosAppId) : fallbackWeb;

  // intent (Ø£ÙØ¶Ù„ Ø¯Ø¹Ù… Ø¹Ù„Ù‰ ÙƒØ±ÙˆÙ…/ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯)
  const intentUrl = "intent://p/" + encodeURIComponent(productId) +
                    "#Intent;scheme=snapmall;package=" + androidPkg +
                    ";S.browser_fallback_url=" + encodeURIComponent(playUrl) +
                    ";end";

  const ua = navigator.userAgent || navigator.vendor || "";
  const isAndroid = /Android/i.test(ua);
  const isIOS     = /iPhone|iPad|iPod/i.test(ua);

  function openFallback() {
    if (isAndroid) {
      location.href = playUrl;
    } else if (isIOS) {
      location.href = appStoreUrl;
    } else {
      location.href = fallbackWeb;
    }
  }

  // ğŸ”’ Ø¥ØºÙ„Ø§Ù‚/Ø±Ø¬ÙˆØ¹ Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø§Ù„ØµÙØ­Ø© ØªØµØ¨Ø­ Ù…Ø®ÙÙŠØ©)
  let closeScheduled = false;
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && !closeScheduled) {
      closeScheduled = true;
      // Ù†Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ù„Ù†Ø¶Ù…Ù† Ø§Ù„ØªØ­ÙˆÙŠÙ„ ØªÙ…
      setTimeout(() => {
        // Ø­Ø§ÙˆÙ„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
        window.close();
        // Ù„Ùˆ Ù…Ø§ Ø³Ù…Ø­ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„Ø¥ØºÙ„Ø§Ù‚:
        if (!document.hidden) return; // Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø³Ø±Ø¹Ø©ØŒ Ù„Ø§ ØªØºÙ„Ù‚
        if (history.length > 1) {
          history.back();
        } else {
          // Ù†Ø§ÙØ°Ø© Ù…Ø³ØªÙ‚Ù„Ø© Ø£Ùˆ Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®: Ø£ÙØ±Øº Ø§Ù„ØµÙØ­Ø©
          location.replace('about:blank');
        }
      }, 800);
    }
  });

  // ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
  function tryAutoOpen() {
    alert(1);
    const t0 = Date.now();

    if (isAndroid) {
      // 1) Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø³ÙƒÙŠÙ… (path Ø«Ù… query) Ø³Ø±ÙŠØ¹Ù‹Ø§
      location.href = schemePath;
      setTimeout(() => { if (Date.now()-t0 < 600) location.href = schemeQuery; }, 200);
      // 2) intent:// Ø£Ù‚ÙˆÙ‰ Ø¯Ø¹Ù… Ø¹Ù„Ù‰ ÙƒØ±ÙˆÙ…/ÙˆØ§ØªØ³Ø§Ø¨
      setTimeout(() => {
        if (Date.now() - t0 < 1200) location.href = intentUrl;
      }, 400);
      // 3) Fallback Ø£Ø®ÙŠØ± Ù„Ùˆ Ù…Ø§ ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„
      setTimeout(() => {
        if (Date.now() - t0 < 1800) openFallback();
      }, 1600);

    } else if (isIOS) {
      // iOS: Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø³ÙƒÙŠÙ… (path Ø«Ù… query) Ø«Ù… Fallback
      location.href = schemePath;
      setTimeout(() => { if (Date.now()-t0 < 800) location.href = schemeQuery; }, 300);
      setTimeout(openFallback, 1200);

    } else {
      openFallback();
    }
  }

  // Ø²Ø± ÙŠØ¯ÙˆÙŠ (Ù„Ùˆ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­ÙØ¬Ø¨ Ø¨ÙˆØ§Ø³Ø·Ø© in-app browser)
  window.tryOpenManually = function () {
    if (isAndroid) {
      location.href = intentUrl;
      setTimeout(() => { location.href = schemeQuery; }, 200);
      setTimeout(() => { location.href = schemePath;  }, 400);
      setTimeout(openFallback, 1500);
    } else if (isIOS) {
      location.href = schemePath;
      setTimeout(() => { location.href = schemeQuery; }, 400);
      setTimeout(openFallback, 1200);
    } else {
      openFallback();
    }
  };

  tryAutoOpen();
  // ÙØ¹Ù‘Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  // window.addEventListener('load', tryAutoOpen);
})();
</script>

<body>
  <h2>Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚â€¦</h2>
  <p class="hint">Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙØªØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŒ Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡:</p>
  <button class="btn" onclick="tryOpenManually()">Ø§ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¢Ù†</button>
  <p class="hint">Ø¥Ù† ØªØ¹Ø°Ù‘Ø± Ø§Ù„ÙØªØ­ØŒ Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„Ù…ØªØ¬Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</p>
</body>
</html>
